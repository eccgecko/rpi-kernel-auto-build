name: Build Raspberry Pi Kernel

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday 06:00 UTC
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if commit has not changed'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: kernel-build
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  check-for-new-commit:
    runs-on: ubuntu-latest
    outputs:
      verified_sha: ${{ steps.find.outputs.verified_sha }}
      short_sha: ${{ steps.find.outputs.short_sha }}
      should_build: ${{ steps.compare.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find latest verified commit
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sha=$(bash scripts/find-verified-commit.sh 20)
          echo "verified_sha=${sha}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${sha:0:7}" >> "$GITHUB_OUTPUT"
          echo "Found verified commit: ${sha}"

      - name: Compare with latest release
        id: compare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          verified_sha="${{ steps.find.outputs.verified_sha }}"
          force="${{ inputs.force_rebuild }}"

          # Get the latest release tag description to find the SHA
          latest_sha=""
          latest_tag=$(gh release list --repo "${{ github.repository }}" --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || true)
          if [[ -n "$latest_tag" ]]; then
            latest_sha=$(gh release view "$latest_tag" --repo "${{ github.repository }}" --json body --jq '.body' 2>/dev/null \
              | grep -oP 'Source commit: \[`\K[a-f0-9]+' || true)
          fi

          if [[ "$force" == "true" ]]; then
            echo "Force rebuild requested"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          elif [[ "$verified_sha" != "$latest_sha" ]]; then
            echo "New commit detected: ${verified_sha} (previous: ${latest_sha:-none})"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "No new commit to build (${verified_sha} already released)"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

  build-kernel:
    needs: check-for-new-commit
    if: needs.check-for-new-commit.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      kver: ${{ steps.build.outputs.kver }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            build-essential \
            bc \
            kmod \
            cpio \
            flex \
            libncurses5-dev \
            libelf-dev \
            libssl-dev \
            libdw-dev \
            dwarves \
            bison \
            debhelper

      - name: Build kernel
        id: build
        run: |
          bash scripts/build-kernel.sh "${{ needs.check-for-new-commit.outputs.verified_sha }}" "${{ github.workspace }}/output"

          # Extract kernel version from the .deb filename
          kver=$(ls output/linux-image-*.deb | head -1 | sed 's/.*linux-image-\(.*\)_.*_arm64.deb/\1/')
          echo "kver=${kver}" >> "$GITHUB_OUTPUT"
          echo "Built kernel version: ${kver}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-debs
          path: output/*.deb
          retention-days: 7

  create-release:
    needs: [check-for-new-commit, build-kernel]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel-debs
          path: debs/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ needs.check-for-new-commit.outputs.verified_sha }}"
          SHORT="${{ needs.check-for-new-commit.outputs.short_sha }}"
          KVER="${{ needs.build-kernel.outputs.kver }}"
          TAG="v${KVER}-${SHORT}"

          NOTES=$(cat <<'BODY'
          ## Raspberry Pi Kernel ${KVER}

          Source commit: [\`${SHA}\`](https://github.com/raspberrypi/linux/commit/${SHA})
          Branch: \`rpi-6.18.y\`

          ### Install via apt (recommended)

          ```bash
          curl -fsSL https://eccgecko.github.io/rpi-kernel-auto-build/KEY.gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/rpi-kernel-auto-build.gpg
          echo "deb [arch=arm64 signed-by=/usr/share/keyrings/rpi-kernel-auto-build.gpg] \
            https://eccgecko.github.io/rpi-kernel-auto-build stable main" \
            | sudo tee /etc/apt/sources.list.d/rpi-kernel-auto-build.list
          sudo apt update && sudo apt install linux-image-${KVER} linux-headers-${KVER}
          sudo reboot
          ```

          ### Manual install

          Download the \`.deb\` files below and install with:
          ```bash
          sudo dpkg -i linux-image-*.deb linux-headers-*.deb
          sudo reboot
          ```
          BODY
          )

          # Expand variables in notes
          NOTES=$(echo "$NOTES" | envsubst)

          gh release create "$TAG" \
            --repo "${{ github.repository }}" \
            --title "Kernel ${KVER}" \
            --notes "$NOTES" \
            debs/*.deb

  update-apt-repo:
    needs: [check-for-new-commit, build-kernel]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel-debs
          path: debs/

      - name: Install apt tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git worktree add repo-pages gh-pages
          else
            mkdir repo-pages
          fi

      - name: Update apt repository
        run: bash scripts/update-apt-repo.sh debs/ repo-pages/ 3

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo-pages
          force_orphan: true
